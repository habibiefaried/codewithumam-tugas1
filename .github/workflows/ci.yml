name: CI Tests

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  test:
    name: Run Unit and API Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: testdb
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass123
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22.4'
          cache: true

      - name: Verify Go installation
        run: go version

      - name: Download dependencies
        run: go mod download

      - name: Create secrets.yml for tests
        run: |
          cat > secrets.yml << 'EOF'
          db_url: localhost
          db_port: 5432
          db_name: testdb
          db_user: testuser
          db_password: testpass123
          port: 8080
          EOF
          echo "secrets.yml created successfully"
          cat secrets.yml

      - name: Build application
        run: |
          go build -o api-server main.go

      - name: Start server in background
        run: |
          ./api-server &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
          echo "Server started with PID: $SERVER_PID"

      - name: Wait for server to be ready
        run: |
          echo "Waiting for server to start..."
          for i in {1..30}; do
            if curl -s http://localhost:8080/health > /dev/null; then
              echo "Server is ready!"
              exit 0
            fi
            echo "Attempt $i: Server not ready yet..."
            sleep 1
          done
          echo "Server failed to start"
          exit 1

      - name: Run API Integration Tests
        run: |
          echo "========================================="
          echo "Running API Integration Tests"
          echo "========================================="
          
          # Health Check
          echo -e "\n1. Health Check"
          curl -f http://localhost:8080/health || exit 1
          
          # Version Check
          echo -e "\n\n2. Version Check"
          curl -f http://localhost:8080/version || exit 1
          
          # Get all categories (empty)
          echo -e "\n\n3. Get all categories (should be empty)"
          RESPONSE=$(curl -s http://localhost:8080/categories)
          echo $RESPONSE
          if [ "$RESPONSE" != "[]" ] && [ "$RESPONSE" != "null" ]; then
            echo "Expected empty array, got: $RESPONSE"
            exit 1
          fi
          
          # Create category 1
          echo -e "\n\n4. Create category: Electronics"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/categories \
            -H "Content-Type: application/json" \
            -d '{"name":"Electronics","description":"Electronic devices"}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" != "201" ]; then
            echo "Expected 201, got: $HTTP_CODE"
            exit 1
          fi
          
          # Create category 2
          echo -e "\n\n5. Create category: Books"
          curl -s -X POST http://localhost:8080/categories \
            -H "Content-Type: application/json" \
            -d '{"name":"Books","description":"Physical and digital books"}'
          
          # Create category 3
          echo -e "\n\n6. Create category: Clothing"
          curl -s -X POST http://localhost:8080/categories \
            -H "Content-Type: application/json" \
            -d '{"name":"Clothing","description":"Apparel items"}'
          
          # Get all categories
          echo -e "\n\n7. Get all categories (should have 3)"
          RESPONSE=$(curl -s http://localhost:8080/categories)
          echo $RESPONSE
          COUNT=$(echo $RESPONSE | grep -o '"id"' | wc -l)
          if [ "$COUNT" != "3" ]; then
            echo "Expected 3 categories, got: $COUNT"
            exit 1
          fi
          
          # Get by ID
          echo -e "\n\n8. Get category by ID: 1"
          RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:8080/categories/1)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Expected 200, got: $HTTP_CODE"
            exit 1
          fi
          
          # Update category
          echo -e "\n\n9. Update category ID: 1"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT http://localhost:8080/categories/1 \
            -H "Content-Type: application/json" \
            -d '{"name":"Electronics and Tech","description":"Updated description"}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Expected 200, got: $HTTP_CODE"
            exit 1
          fi
          if ! echo $BODY | grep -q "Electronics and Tech"; then
            echo "Update failed - name not updated correctly"
            exit 1
          fi
          
          # Product endpoints (CRUD) - ensure category relationship is present
          echo -e "\n\n10. Product: Create product linked to category 1"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/products \
            -H "Content-Type: application/json" \
            -d '{"name":"Phone","price":299,"stock":10,"category_id":1}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" != "201" ]; then
            echo "Expected 201 for product create, got: $HTTP_CODE"
            exit 1
          fi

          # Create another product
          echo -e "\n\n11. Product: Create another product linked to category 2"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/products \
            -H "Content-Type: application/json" \
            -d '{"name":"Book","price":20,"stock":50,"category_id":2}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" != "201" ]; then
            echo "Expected 201 for product create, got: $HTTP_CODE"
            exit 1
          fi

          # Get all products (should have at least 2)
          echo -e "\n\n12. Get all products"
          RESPONSE=$(curl -s http://localhost:8080/products)
          echo $RESPONSE
          COUNT=$(echo $RESPONSE | grep -o '"id"' | wc -l)
          if [ "$COUNT" -lt 2 ]; then
            echo "Expected at least 2 products, got: $COUNT"
            exit 1
          fi

          # Get product by ID and verify category fields
          echo -e "\n\n13. Get product by ID: 1 and verify category info"
          RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:8080/products/1)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Expected 200 for product get, got: $HTTP_CODE"
            exit 1
          fi
          if ! echo $BODY | grep -q "category_name"; then
            echo "Expected category_name in product response"
            exit 1
          fi

          # Update product
          echo -e "\n\n14. Update product ID: 1"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT http://localhost:8080/products/1 \
            -H "Content-Type: application/json" \
            -d '{"name":"Smartphone","price":399,"stock":5,"category_id":1}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Expected 200 for product update, got: $HTTP_CODE"
            exit 1
          fi

          # Checkout - success
          echo -e "\n\n14b. Checkout: successful transaction"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/checkout \
            -H "Content-Type: application/json" \
            -d '{"items":[{"product_id":1,"quantity":2},{"product_id":2,"quantity":3}]}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" != "201" ]; then
            echo "Expected 201 for checkout, got: $HTTP_CODE"
            echo "Response body: $BODY"
            exit 1
          fi
          if ! echo $BODY | grep -q '"total_amount"'; then
            echo "Expected total_amount in checkout response"
            exit 1
          fi

          # Verify stock decreased for product 1 and 2
          echo -e "\n\n14c. Verify stock decreased after checkout"
          RESPONSE=$(curl -s http://localhost:8080/products/1)
          echo $RESPONSE
          if ! echo $RESPONSE | grep -q '"stock":3'; then
            echo "Expected stock 3 for product 1"
            exit 1
          fi
          RESPONSE=$(curl -s http://localhost:8080/products/2)
          echo $RESPONSE
          if ! echo $RESPONSE | grep -q '"stock":47'; then
            echo "Expected stock 47 for product 2"
            exit 1
          fi

          # Checkout - insufficient stock
          echo -e "\n\n14d. Checkout: insufficient stock (should fail)"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/checkout \
            -H "Content-Type: application/json" \
            -d '{"items":[{"product_id":1,"quantity":999}]}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" != "400" ]; then
            echo "Expected 400 for insufficient stock, got: $HTTP_CODE"
            exit 1
          fi

          # Checkout - product not found
          echo -e "\n\n14e. Checkout: product not found (should fail)"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/checkout \
            -H "Content-Type: application/json" \
            -d '{"items":[{"product_id":9999,"quantity":1}]}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" != "404" ]; then
            echo "Expected 404 for product not found, got: $HTTP_CODE"
            exit 1
          fi

          # Checkout - empty items
          echo -e "\n\n14f. Checkout: empty items (should fail)"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/checkout \
            -H "Content-Type: application/json" \
            -d '{"items":[]}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" != "400" ]; then
            echo "Expected 400 for empty items, got: $HTTP_CODE"
            exit 1
          fi

          # Checkout - invalid quantity
          echo -e "\n\n14g. Checkout: invalid quantity (should fail)"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/checkout \
            -H "Content-Type: application/json" \
            -d '{"items":[{"product_id":1,"quantity":0}]}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" != "400" ]; then
            echo "Expected 400 for invalid quantity, got: $HTTP_CODE"
            exit 1
          fi

          # Report - today
          echo -e "\n\n14h. Report: today"
          RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:8080/report/hari-ini)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Expected 200 for report today, got: $HTTP_CODE"
            exit 1
          fi
          if ! echo $BODY | grep -q '"total_revenue"'; then
            echo "Expected total_revenue in report today"
            exit 1
          fi

          # Report - range
          echo -e "\n\n14i. Report: range"
          TODAY=$(date -u +%F)
          RESPONSE=$(curl -s -w "\n%{http_code}" "http://localhost:8080/report?start_date=$TODAY&end_date=$TODAY")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Expected 200 for report range, got: $HTTP_CODE"
            exit 1
          fi
          if ! echo $BODY | grep -q '"produk_terlaris"'; then
            echo "Expected produk_terlaris in report range"
            exit 1
          fi

          # Scenario: admin updates price between checkouts
          echo -e "\n\n14j. Scenario: admin updates price between checkouts"
          # Create a new product for scenario
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/products \
            -H "Content-Type: application/json" \
            -d '{"name":"Milk","price":100,"stock":10,"category_id":1}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" != "201" ]; then
            echo "Expected 201 for product create, got: $HTTP_CODE"
            exit 1
          fi

          # First checkout (price 100)
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/checkout \
            -H "Content-Type: application/json" \
            -d '{"items":[{"product_id":3,"quantity":2}]}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" != "201" ]; then
            echo "Expected 201 for checkout, got: $HTTP_CODE"
            exit 1
          fi

          # Admin updates price
          RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT http://localhost:8080/products/3 \
            -H "Content-Type: application/json" \
            -d '{"name":"Milk","price":150,"stock":8,"category_id":1}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Expected 200 for product update, got: $HTTP_CODE"
            exit 1
          fi

          # Second checkout (price 150)
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/checkout \
            -H "Content-Type: application/json" \
            -d '{"items":[{"product_id":3,"quantity":1}]}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" != "201" ]; then
            echo "Expected 201 for checkout, got: $HTTP_CODE"
            exit 1
          fi

          # Report should still succeed after admin changes
          RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:8080/report/hari-ini)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Expected 200 for report today, got: $HTTP_CODE"
            exit 1
          fi

          # Delete product (should succeed even if referenced in transaction detail)
          echo -e "\n\n15. Delete product ID: 2"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X DELETE http://localhost:8080/products/2)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" != "204" ]; then
            echo "Expected 204 for product delete, got: $HTTP_CODE"
            exit 1
          fi

          # Test foreign key constraint - try to delete category that has products
          echo -e "\n\n15b. Test foreign key constraint: Delete category with products (should fail with 409)"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X DELETE http://localhost:8080/categories/1)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" != "409" ]; then
            echo "Expected 409 Conflict, got: $HTTP_CODE"
            exit 1
          fi
          if ! echo $BODY | grep -q "Cannot delete category"; then
            echo "Expected error message about constraint violation"
            exit 1
          fi

          # Test validation - empty name
          echo -e "\n\n16. Test validation: empty name (should fail)"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/categories \
            -H "Content-Type: application/json" \
            -d '{"name":"","description":"Should fail"}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" != "400" ]; then
            echo "Expected 400, got: $HTTP_CODE"
            exit 1
          fi
          
          # Test whitespace-only name
          echo -e "\n\n16b. Test whitespace-only name (should fail)"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/categories \
            -H "Content-Type: application/json" \
            -d '{"name":"   ","description":"Should fail"}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" != "400" ]; then
            echo "Expected 400 for whitespace, got: $HTTP_CODE"
            exit 1
          fi
          
          # Test very long name (>255 chars)
          echo -e "\n\n16c. Test very long name (should fail)"
          LONG_NAME=$(printf 'a%.0s' {1..300})
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/categories \
            -H "Content-Type: application/json" \
            -d "{\"name\":\"$LONG_NAME\",\"description\":\"Should fail\"}")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" != "400" ]; then
            echo "Expected 400 for long name, got: $HTTP_CODE"
            exit 1
          fi
          
          # Test invalid ID
          echo -e "\n\n17. Test invalid ID (should fail)"
          RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:8080/categories/abc)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" != "400" ]; then
            echo "Expected 400, got: $HTTP_CODE"
            exit 1
          fi

          # Test negative product price
          echo -e "\n\n17b. Test negative product price (should fail)"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/products \
            -H "Content-Type: application/json" \
            -d '{"name":"BadProduct","price":-50,"stock":10,"category_id":1}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" != "400" ]; then
            echo "Expected 400 for negative price, got: $HTTP_CODE"
            exit 1
          fi
          
          # Test negative product stock
          echo -e "\n\n17c. Test negative product stock (should fail)"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/products \
            -H "Content-Type: application/json" \
            -d '{"name":"BadProduct","price":100,"stock":-5,"category_id":1}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" != "400" ]; then
            echo "Expected 400 for negative stock, got: $HTTP_CODE"
            exit 1
          fi
          
          # Test non-existent category
          echo -e "\n\n17d. Test product with non-existent category (should fail)"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/products \
            -H "Content-Type: application/json" \
            -d '{"name":"Orphan","price":100,"stock":5,"category_id":9999}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" != "400" ]; then
            echo "Expected 400 for invalid category, got: $HTTP_CODE"
            exit 1
          fi
          
          # Test update product with non-existent category
          echo -e "\n\n17e. Test update product with non-existent category (should fail)"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT http://localhost:8080/products/1 \
            -H "Content-Type: application/json" \
            -d '{"name":"Updated","price":299,"stock":10,"category_id":9999}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" != "400" ]; then
            echo "Expected 400 for invalid category on update, got: $HTTP_CODE"
            exit 1
          fi

          # Delete category
          echo -e "\n\n18. Delete category ID: 2"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X DELETE http://localhost:8080/categories/2)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" != "204" ]; then
            echo "Expected 204, got: $HTTP_CODE"
            exit 1
          fi
          
          # Verify deletion
          echo -e "\n\n19. Verify category 2 is deleted (should get 404)"
          RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:8080/categories/2)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" != "404" ]; then
            echo "Expected 404, got: $HTTP_CODE"
            exit 1
          fi

          # Additional CRUD tests for Categories
          echo -e "\n\n20. Create additional category: Home & Garden"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/categories \
            -H "Content-Type: application/json" \
            -d '{"name":"Home & Garden","description":"Home and garden products"}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" != "201" ]; then
            echo "Expected 201, got: $HTTP_CODE"
            exit 1
          fi
          
          # Create another category
          echo -e "\n\n21. Create category: Sports & Outdoors"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/categories \
            -H "Content-Type: application/json" \
            -d '{"name":"Sports & Outdoors","description":"Sports and outdoor equipment"}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" != "201" ]; then
            echo "Expected 201, got: $HTTP_CODE"
            exit 1
          fi
          
          # Get all remaining categories (should have 4: Electronics, Clothing, Home & Garden, Sports)
          echo -e "\n\n22. Verify all categories exist (expect 4)"
          RESPONSE=$(curl -s http://localhost:8080/categories)
          echo $RESPONSE
          COUNT=$(echo $RESPONSE | grep -o '"id"' | wc -l)
          if [ "$COUNT" != "4" ]; then
            echo "Expected 4 categories, got: $COUNT"
            exit 1
          fi
          
          # Update category 3 (Clothing)
          echo -e "\n\n23. Update category ID: 3 (Clothing)"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT http://localhost:8080/categories/3 \
            -H "Content-Type: application/json" \
            -d '{"name":"Fashion & Apparel","description":"Updated clothing and fashion items"}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Expected 200, got: $HTTP_CODE"
            exit 1
          fi
          if ! echo $BODY | grep -q "Fashion"; then
            echo "Update failed - name not updated correctly"
            exit 1
          fi

          # Additional CRUD tests for Products
          echo -e "\n\n24. Create additional product: Laptop"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/products \
            -H "Content-Type: application/json" \
            -d '{"name":"Laptop","price":1299,"stock":8,"category_id":1}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" != "201" ]; then
            echo "Expected 201, got: $HTTP_CODE"
            exit 1
          fi
          
          # Create another product in Sports category
          echo -e "\n\n25. Create product: Running Shoes in Sports category"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/products \
            -H "Content-Type: application/json" \
            -d '{"name":"Running Shoes","price":89,"stock":25,"category_id":5}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" != "201" ]; then
            echo "Expected 201, got: $HTTP_CODE"
            exit 1
          fi
          
          # Get all products (should have at least 3 now: Phone, Laptop, Running Shoes)
          echo -e "\n\n26. Get all products (verify at least 3 exist)"
          RESPONSE=$(curl -s http://localhost:8080/products)
          echo $RESPONSE
          COUNT=$(echo $RESPONSE | grep -o '"id"' | wc -l)
          if [ "$COUNT" -lt 3 ]; then
            echo "Expected at least 3 products, got: $COUNT"
            exit 1
          fi
          
          # Update product 3 (the Laptop)
          echo -e "\n\n27. Update product ID: 3 - increase price"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT http://localhost:8080/products/3 \
            -H "Content-Type: application/json" \
            -d '{"name":"Laptop Pro","price":1599,"stock":5,"category_id":1}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Expected 200 for product update, got: $HTTP_CODE"
            exit 1
          fi
          if ! echo $BODY | grep -q "Laptop Pro"; then
            echo "Update failed - name not updated correctly"
            exit 1
          fi
          
          # Get updated product and verify price
          echo -e "\n\n28. Verify product 3 update - check price is 1599"
          RESPONSE=$(curl -s http://localhost:8080/products/3)
          echo $RESPONSE
          if ! echo $RESPONSE | grep -q '"price":1599'; then
            echo "Price not updated correctly"
            exit 1
          fi
          
          # Delete product 4 (Running Shoes)
          echo -e "\n\n29. Delete product ID: 4"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X DELETE http://localhost:8080/products/4)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" != "204" ]; then
            echo "Expected 204 for product delete, got: $HTTP_CODE"
            exit 1
          fi
          
          # Verify deletion - try to get deleted product
          echo -e "\n\n30. Verify product 4 is deleted (should get 404)"
          RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:8080/products/4)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" != "404" ]; then
            echo "Expected 404 for deleted product, got: $HTTP_CODE"
            exit 1
          fi

          # Edge Case Tests
          echo -e "\n\n========================================="
          echo "Running Edge Case Tests"
          echo "========================================="
          
          # Test 31: Category with zero/empty price for product
          echo -e "\n\n31. Edge Case: Create product with zero price (should fail)"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/products \
            -H "Content-Type: application/json" \
            -d '{"name":"Invalid Product","price":0,"stock":10,"category_id":1}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" = "201" ]; then
            echo "Warning: Server accepted zero price product (should validate at API layer)"
          fi
          
          # Test 32: Product with negative stock
          echo -e "\n\n32. Edge Case: Create product with negative stock (should fail)"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/products \
            -H "Content-Type: application/json" \
            -d '{"name":"Negative Stock","price":99,"stock":-5,"category_id":1}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" = "201" ]; then
            echo "Warning: Server accepted negative stock (should validate at API layer)"
          fi
          
          # Test 33: Product with non-existent category
          echo -e "\n\n33. Edge Case: Create product with non-existent category ID"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/products \
            -H "Content-Type: application/json" \
            -d '{"name":"Orphan Product","price":100,"stock":5,"category_id":9999}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" = "201" ]; then
            echo "Warning: Server accepted product with non-existent category"
          fi
          
          # Test 34: Category with whitespace-only name
          echo -e "\n\n34. Edge Case: Create category with whitespace-only name"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/categories \
            -H "Content-Type: application/json" \
            -d '{"name":"   ","description":"Valid description"}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" = "201" ]; then
            echo "Note: Server created category with whitespace name (validation at API layer)"
          fi
          
          # Test 35: Category with empty description
          echo -e "\n\n35. Edge Case: Create category with empty description"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/categories \
            -H "Content-Type: application/json" \
            -d '{"name":"ValidName","description":""}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" = "201" ]; then
            echo "Note: Server created category with empty description (should validate)"
          fi
          
          # Test 36: Category name exceeding max length (255 chars)
          echo -e "\n\n36. Edge Case: Create category with name > 255 characters"
          LONG_NAME=$(python3 -c "print('a' * 256)")
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/categories \
            -H "Content-Type: application/json" \
            -d "{\"name\":\"$LONG_NAME\",\"description\":\"Test\"}")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" = "201" ]; then
            echo "Error: Server accepted name > 255 characters"
            exit 1
          fi
          
          # Test 37: Update product with invalid category ID
          echo -e "\n\n37. Edge Case: Update product with non-existent category ID"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT http://localhost:8080/products/1 \
            -H "Content-Type: application/json" \
            -d '{"name":"Updated","price":200,"stock":5,"category_id":9999}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" = "200" ]; then
            echo "Note: Server accepted update with non-existent category (validation at API layer)"
          fi
          
          # Test 38: Update category with whitespace name
          echo -e "\n\n38. Edge Case: Update category with whitespace-only name"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT http://localhost:8080/categories/1 \
            -H "Content-Type: application/json" \
            -d '{"name":"   ","description":"Valid description"}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" = "200" ]; then
            echo "Note: Server accepted update with whitespace name (validation at API layer)"
          fi
          
          # Test 39: Update category with empty description
          echo -e "\n\n39. Edge Case: Update category with empty description"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT http://localhost:8080/categories/2 \
            -H "Content-Type: application/json" \
            -d '{"name":"ValidName","description":""}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo $BODY
          if [ "$HTTP_CODE" = "200" ]; then
            echo "Note: Server accepted update with empty description (should validate)"
          fi

          echo -e "\n\n========================================="
          echo "✅ All tests passed!"
          echo "========================================="

      - name: Stop server
        if: always()
        run: |
          if [ ! -z "$SERVER_PID" ]; then
            kill $SERVER_PID || true
          fi
          pkill -f api-server || true

      - name: Show test results
        if: always()
        run: |
          if [ $? -eq 0 ]; then
            echo "✅ Tests PASSED"
          else
            echo "❌ Tests FAILED"
            exit 1
          fi
